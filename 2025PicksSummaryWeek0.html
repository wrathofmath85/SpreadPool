<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spread Pool — Picks</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net/">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --bg:#ffffff; --text:#111; --muted:#666; --rule:#ddd; --accent:#0b61ff;
    --green:#16a34a; --red:#dc2626; --gray:#6b7280; --chip:#0b5; --count:#b45309;
    --neon:#39ff14; --neonText:#062b00;
  }
  html,body{background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif;margin:0}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px 64px}
  h1{margin:0 0 12px}
  #err{display:none;color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;padding:8px 12px;border-radius:8px;margin:8px 0}

  /* TOP GAMES PANEL */
  .games{border:1px solid var(--rule);border-radius:10px;padding:12px;margin:8px 0 20px}
  .game{display:grid;grid-template-columns: 1fr auto auto auto;gap:8px;align-items:center;border-bottom:1px solid var(--rule);padding:6px 0}
  .game:last-child{border-bottom:0}
  .gline{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .gbtn{border:1px solid var(--rule);background:#f7f7f7;border-radius:8px;padding:4px 8px;cursor:pointer;font-weight:600;font-size:12px;white-space:nowrap}
  .gbtn .count{font-weight:700;color:var(--count);margin-left:4px}
  .gbtn.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(11,97,255,.15)}
  .gbtn.away.active{background:#eef3ff}
  .gbtn.home.active{background:#eefaf0}
  .gbtn.tie.active{background:#f3f4f6}
  .note{color:var(--muted);font-size:12px;margin-top:6px}

  /* PEOPLE GRID */
  #list{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:16px}
  @media (max-width: 900px){ #list{grid-template-columns:1fr} }

  /* PEOPLE CARDS & TABLES */
  .person{border:1px solid var(--rule);border-radius:10px;padding:10px}
  .header{display:flex;align-items:center;gap:10px;margin-bottom:6px}
  .pname{font-weight:800;font-size:16px;margin:0}
  .badge-defaults{
    background:var(--neon); color:var(--neonText); font-weight:900;
    padding:2px 8px; border-radius:999px; text-transform:uppercase; letter-spacing:.5px;
    box-shadow:0 0 8px rgba(57,255,20,.6), inset 0 0 2px rgba(0,0,0,.2);
    font-size:11px;
  }
  table{width:100%;border-collapse:collapse}
  th,td{padding:6px 6px;vertical-align:top;font-size:12px;line-height:1.1}
  th{text-align:left;border-bottom:2px solid #000}
  td{border-bottom:1px solid var(--rule)}
  .col-idx{width:28px;text-align:right;color:var(--muted)}
  .col-line{width:62%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .col-pick{white-space:nowrap}
  .result-win{color:var(--green);font-weight:700}
  .result-loss{color:var(--red);font-weight:700}
  .result-tie{color:var(--gray);font-weight:700}
  .double::after{content:" ×2";color:var(--chip);font-weight:700}
  tfoot td{font-weight:700}
  .mono{font-variant-numeric: tabular-nums}

  /* STANDINGS */
  .standings{margin-top:28px}
  .standings h2{margin:8px 0 10px}
  .toolbar{display:flex;gap:8px;margin:8px 0 12px}
  .toolbar button{padding:6px 10px;border:1px solid var(--rule);background:#f7f7f7;border-radius:8px;cursor:pointer}
  .toolbar button.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(11,97,255,.15)}
  .standings table{width:100%}
  .standings td,.standings th{padding:8px;border-bottom:1px solid var(--rule)}
  .standings th{text-align:left;border-bottom:2px solid #000}
  .rank{width:42px;text-align:right;color:#888}
  .stat{width:100px;text-align:right}
  .nameCell{display:flex;align-items:center;gap:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Spread Pool — Picks</h1>

  <div id="err"></div>

  <div id="gamesPanel" class="games"></div>
  <div class="note">Set the official result per game. If the <strong>Winner</strong> column is filled in a Lines sheet, the game is locked for everyone. Totals & standings update instantly.</div>

  <div id="list"></div>

  <div class="standings" id="standingsWrap" hidden>
    <h2>Standings</h2>
    <div class="toolbar">
      <button id="sort-alpha">Alphabetical</button>
      <button id="sort-percent">By Win %</button>
      <button id="sort-wins">Most Wins</button>
    </div>
    <div id="standings"></div>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const WeekNumber = 0;  // <-- filter Submissions to this week

/* Publish each tab as CSV and paste URLs here */
const CSV_URL_NCAA_LINES   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT1sgv7_gnDt5DoVxF3jXAU6KTZB8U7azy8AMDdODEhUnnQf1gLK7hgSTktI-X4tF5Zo7ELzG2PfEDE/pub?gid=0&single=true&output=csv";
const CSV_URL_NFL_LINES    = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT1sgv7_gnDt5DoVxF3jXAU6KTZB8U7azy8AMDdODEhUnnQf1gLK7hgSTktI-X4tF5Zo7ELzG2PfEDE/pub?gid=2109553148&single=true&output=csv";
const CSV_URL_SUBS         = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRys9xayYsuEqgGB09v1nOrwdD0U5c1Hb1ksLqQxTSBzLi3AKGeg9yPt1-eY1fry_0H-KcZLCQ1h8H6/pub?gid=1991283502&single=true&output=csv";
const CSV_URL_PARTICIPANTS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRj5ieGlGWurIlGuongV3vJhWWAwCYsEFVhEEtjwOG7RiFwTRZkM_JXtjb8QtwsdzhaXPMDRPyU7qZC/pub?gid=0&single=true&output=csv";
const DOUBLE_COUNTS_AS = 2;

/* ================ HELPERS =================== */
const by = f => (a,b)=> f(a)<f(b)?-1:f(a)>f(b)?1:0;
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}
function qidOrder(q){ if(!q) return 9999; const s=q[0], n=parseInt(q.slice(1),10); return (s==='A'?0:1)*1000 + (isFinite(n)?n:999); }
function showErr(msg){
  const box = document.getElementById('err');
  if (!box) return;
  if (msg) {
    box.style.display='block';
    box.innerHTML = escapeHtml(msg) +
      '<div style="margin-top:6px;font-size:12px;opacity:.8">NFL Lines: '+escapeHtml(CSV_URL_NFL_LINES)+
      '<br>NCAA Lines: '+escapeHtml(CSV_URL_NCAA_LINES)+
      '<br>Subs: '+escapeHtml(CSV_URL_SUBS)+
      '<br>Participants: '+escapeHtml(CSV_URL_PARTICIPANTS)+'</div>';
  } else { box.style.display='none'; box.innerHTML=''; }
}
function fetchCSV(url){
  const bust = (url.includes('?') ? '&' : '?') + 'cb=' + Date.now();
  return new Promise((resolve,reject)=>{
    Papa.parse(url + bust,{
      download:true, header:true, dynamicTyping:false, skipEmptyLines:true,
      complete:res=>{
        const row0 = res && res.data && res.data[0] ? res.data[0] : null;
        const firstCell = row0 ? String(Object.values(row0)[0] ?? '') : '';
        if (/^<\s*!?doctype|^<\s*html/i.test(firstCell)) {
          reject(new Error('Got HTML instead of CSV. Use a "Publish to web → CSV" link.'));
          return;
        }
        resolve(res.data);
      },
      error:err=>reject(err)
    });
  });
}
function normTeam(s){
  s = String(s||"").trim();
  if(!s) return "";
  s = s.replace(/\s*\([^)]*\)\s*$/,"").trim(); // drop trailing (...) (e.g., lines)
  s = s.replace(/^#\d+\s+/,"").trim();         // drop rank
  return s.toLowerCase();
}
function fmtPct(n){ return (isNaN(n) ? "" : (n*100).toFixed(1) + "%"); }
function toDate(val){ if(!val) return null; const d = new Date(val); return isNaN(+d) ? null : d; }
function escapeRegex(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');}

/* ---- Parse ET date & time (like "Aug 30, 2025" + "12:00 PM") into a JS Date ---- */
function getETOffsetMinutes(y,mo,d){
  const probeUTC = Date.UTC(y,mo-1,d,12,0);
  const parts = new Intl.DateTimeFormat('en-US',{timeZone:'America/New_York',timeZoneName:'shortOffset'}).formatToParts(new Date(probeUTC));
  const z = (parts.find(p=>p.type==='timeZoneName')||{}).value || 'GMT-05';
  const m = z.match(/GMT([+-]\d{1,2})(?::(\d{2}))?/); if(!m) return -300;
  const hr = parseInt(m[1],10), mm = m[2]?parseInt(m[2],10):0;
  return hr*60 + (hr<0?-mm:mm);
}
function parseETDate(dateStr){
  const s = String(dateStr||"").trim();
  let m = s.replace(/\./g,'').match(/^([A-Za-z]+)\s+(\d{1,2}),\s*(\d{4})$/);
  if(m){
    const L={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12,august:8,september:9,october:10,november:11,december:12};
    const mo=L[m[1].toLowerCase()]; if(mo) return {y:+m[3], mo, d:+m[2]};
  }
  m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); if(m) return {y:+m[3], mo:+m[1], d:+m[2]};
  m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);        if(m) return {y:+m[1], mo:+m[2], d:+m[3]};
  return null;
}
function parseETTime(timeStr){
  const s = String(timeStr||"").trim();
  const m = s.match(/^(\d{1,2}):(\d{2})\s*([AP]M)$/i);
  if(!m) return {h:12,mi:0};
  let h=+m[1], mi=+m[2]; const ampm=m[3].toUpperCase();
  if(ampm==="PM"&&h!==12) h+=12; if(ampm==="AM"&&h===12) h=0;
  return {h,mi};
}
function makeDateFromET(dateStr,timeStr){
  const d = parseETDate(dateStr);
  if(!d) return null;
  const t = parseETTime(timeStr);
  const offMin = getETOffsetMinutes(d.y,d.mo,d.d);
  const utcMs = Date.UTC(d.y,d.mo-1,d.d,t.h,t.mi) - offMin*60*1000;
  const dt = new Date(utcMs);
  return isNaN(+dt) ? null : dt;
}

/* ============== STATE ============== */
const qidToLine   = new Map();      // QID -> display line
const qidToAway   = new Map();      // QID -> Away team (raw)
const qidToHome   = new Map();      // QID -> Home team (raw)
const qidToWinner = new Map();      // QID -> Winner raw ("Tie" or team) or ""
const qidToDate   = new Map();      // QID -> Date object
const qidToSpread = new Map();      // QID -> spread text
const qidToDefault= new Map();      // QID -> 'Y' if part of defaults list in sheet
const results     = new Map();      // QID -> 'away' | 'home' | 'tie'
let people        = [];             // [{name, picks:[{qid, choice, isDouble}], isDefaults?:true}]
let participantNames = [];          // roster
let defaultTemplate = null;         // { name:"Default Picks", picks:[...] }
let standingsSort = 'alpha';        // 'alpha' | 'percent' | 'wins'

/* ======== LINES (shared schema) ========
   Columns expected: QID, Away Team, Home Team, Date, Time, TV, Location, Spread, Required, Default, Winner (optional)
*/
function normalizeLines(rows, league){ // league = 'A' (NFL) or 'B' (NCAA) by QID prefix
  rows.forEach(r=>{
    const qid   = String(r["QID"]||r["qid"]||"").trim();
    if(!qid) return;
    const away  = String(r["Away Team"]||r["Away"]||"").trim();
    const home  = String(r["Home Team"]||r["Home"]||"").trim();
    const date  = String(r["Date"]||"").trim();
    const time  = String(r["Time"]||"").trim();
    const spread= String(r["Spread"]||r["Line"]||"").trim();  // may be like "#3 Ohio State -1.5"
    const req   = String(r["Required"]||"").trim();
    const deflt = /^y/i.test(String(r["Default"]||""));
    const winner= String(r["Winner"]||"").trim();

    // Build a display line as "Away (−x if favored) @ Home (−x if favored)"
    const fav = detectFavoriteFromSpread(away, home, spread);
    const awayTag = fav && fav.team === 'away' ? ` (${fav.minus})` : '';
    const homeTag = fav && fav.team === 'home' ? ` (${fav.minus})` : '';
    const line = `${away}${awayTag} @ ${home}${homeTag}`;

    qidToLine.set(qid, line);
    qidToAway.set(qid, away);
    qidToHome.set(qid, home);
    qidToDate.set(qid, makeDateFromET(date, time));
    qidToSpread.set(qid, spread);
    qidToDefault.set(qid, deflt ? 'Y' : '');
    if(winner) qidToWinner.set(qid, winner);
  });
}

/* ----- Favorite detection from Spread text (only show − for favorite) ----- */
function detectFavoriteFromSpread(away, home, spreadText){
  const s = String(spreadText||"");
  if(!s) return null;

  // Try to find "Team -x.x"
  // Remove ranks in comparison
  const stripRank = t => String(t||"").replace(/^#\d+\s*/,'').trim();
  const awayKey = stripRank(away);
  const homeKey = stripRank(home);

  const rx = (team)=> new RegExp("\\b"+escapeRegex(team)+"\\b[^-+\\d]*(-\\d+(?:\\.\\d+)?)","i");
  const mHome = rx(homeKey).exec(s);
  if(mHome) return { team:'home', minus: mHome[1] }; // already includes the minus sign
  const mAway = rx(awayKey).exec(s);
  if(mAway) return { team:'away', minus: mAway[1] };

  // If just a raw number appears with a minus, assume home favored
  const lone = s.match(/-(\d+(?:\.\d+)?)/);
  if(lone) return { team:'home', minus: '-'+lone[1] };

  return null;
}

/* ============== SUBMISSIONS & PARTICIPANTS ============== */
function normalizeSubs(rows){
  // filter to WeekNumber
  const filtered = rows.filter(r => String(r["Week"]||r["week"]||"").trim() === String(WeekNumber));

  // keep latest submission per person
  const latest = new Map(); // name => ts
  filtered.forEach(r=>{
    const name = String(r["Name"]||r["name"]||"").trim();
    if(!name) return;
    const ts = String(r["Timestamp"]||r["timestamp"]||"").trim();
    const prev = latest.get(name);
    if(!prev || ts > prev) latest.set(name, ts);
  });

  const byName = new Map();
  filtered.forEach(r=>{
    const name   = String(r["Name"]||r["name"]||"").trim();
    const ts     = String(r["Timestamp"]||r["timestamp"]||"").trim();
    const qid    = String(r["QID"]||r["qid"]||"").trim();
    const choice = String(r["Choice"]||r["choice"]||"").trim();
    const isDouble = String(r["IsDouble"]).toUpperCase()==="TRUE";
    if(!name || !qid) return;
    if(latest.get(name) && ts !== latest.get(name)) return;

    const p = byName.get(name) || { name, picks: [] };
    p.picks.push({ qid, choice, isDouble });
    byName.set(name, p);
  });

  const arr = Array.from(byName.values());
  arr.forEach(p => p.picks.sort((a,b)=> qidOrder(a.qid)-qidOrder(b.qid)));
  // sort by LAST NAME
  arr.sort((a,b)=> lastName(a.name).localeCompare(lastName(b.name)) || a.name.localeCompare(b.name));
  return arr;
}
function normalizeParticipants(rows){
  const set = new Set();
  rows.forEach(r=>{
    const nm = String(r["Name"]||r["name"]||"").trim();
    if(nm) set.add(nm);
  });
  return Array.from(set).sort((a,b)=> lastName(a).localeCompare(lastName(b)) || a.localeCompare(b));
}
function lastName(full){
  const parts = String(full||"").trim().split(/\s+/);
  return parts.length ? parts[parts.length-1].toLowerCase() : "";
}

/* Winner column → outcome (locks games globally) */
function outcomeFromWinner(qid){
  const w = (qidToWinner.get(qid) || "").trim();
  if(!w) return undefined;
  if (/^tie$/i.test(w)) return 'tie';
  const wNorm = normTeam(w);
  if (wNorm && wNorm === normTeam(qidToAway.get(qid)||"")) return 'away';
  if (wNorm && wNorm === normTeam(qidToHome.get(qid)||"")) return 'home';
  return undefined;
}

/* ---------- Build Default Picks set (7 games) ---------- */
function computeDefaultPicksSet(){
  // Set of qids marked Default="Y" in sheets
  const allQids = Array.from(qidToLine.keys());
  const defQids = allQids.filter(q => qidToDefault.get(q)==='Y');

  const pickFav = (qid)=> {
    const fav = detectFavoriteFromSpread(qidToAway.get(qid)||"", qidToHome.get(qid)||"", qidToSpread.get(qid)||"");
    if(!fav) return null;
    const choice = (fav.team==='home') ? qidToHome.get(qid) : qidToAway.get(qid);
    return { qid, choice, isDouble:false };
  };

  const chosen = [];
  const seen = new Set();

  function add(qid){
    if(!qid || seen.has(qid)) return;
    const p = pickFav(qid);
    if(!p) return;
    chosen.push(p); seen.add(qid);
  }

  // helpers
  const isA = q => q.startsWith('A'); // NFL
  const isB = q => q.startsWith('B'); // NCAA

  // 1) Required College (first one)
  const reqB = defQids.filter(q=>isB(q)).sort((a,b)=>qidOrder(a)-qidOrder(b));
  if(reqB.length) add(reqB[0]);

  // 2) Required NFL (first one)
  const reqA = defQids.filter(q=>isA(q)).sort((a,b)=>qidOrder(a)-qidOrder(b));
  if(reqA.length) add(reqA[0]);

  // 3) First 2 College games on Saturday
  const bSat = allQids
    .filter(q=>isB(q) && qidToDate.get(q) && qidToDate.get(q).getDay()===6)
    .sort((a,b)=> (qidToDate.get(a)-qidToDate.get(b)) || qidOrder(a)-qidOrder(b));
  for(const q of bSat){ if(chosen.length>=3) break; add(q); } // after two adds, chosen length will be 3 (1 B required + 2 Sat) or fewer if duplicates

  // 4) First 3 NFL games on Sunday
  const aSun = allQids
    .filter(q=>isA(q) && qidToDate.get(q) && qidToDate.get(q).getDay()===0)
    .sort((a,b)=> (qidToDate.get(a)-qidToDate.get(b)) || qidOrder(a)-qidOrder(b));
  for(const q of aSun){ if(chosen.length>=7) break; add(q); }

  // Ensure total of 7 (fallback by earliest remaining)
  if(chosen.length<7){
    const rest = allQids.filter(q=>!seen.has(q)).sort((a,b)=> qidOrder(a)-qidOrder(b));
    for(const q of rest){ if(chosen.length>=7) break; add(q); }
  }

  chosen.sort((a,b)=> qidOrder(a.qid)-qidOrder(b.qid));
  return chosen;
}

/* =================== LOAD ALL =================== */
async function loadAll(){
  try{
    showErr('');
    const [nflLines, ncaaLines, subs, parts] = await Promise.all([
      fetchCSV(CSV_URL_NFL_LINES),
      fetchCSV(CSV_URL_NCAA_LINES),
      fetchCSV(CSV_URL_SUBS),
      fetchCSV(CSV_URL_PARTICIPANTS)
    ]);

    // reset maps
    qidToLine.clear(); qidToAway.clear(); qidToHome.clear(); qidToWinner.clear();
    qidToDate.clear(); qidToSpread.clear(); qidToDefault.clear(); results.clear();

    normalizeLines(nflLines, 'A');
    normalizeLines(ncaaLines, 'B');

    // prefill locked results from Winner column (if present)
    Array.from(qidToLine.keys()).forEach(qid=>{
      const oc = outcomeFromWinner(qid);
      if(oc) results.set(qid, oc);
    });

    // normalize datasets
    people = normalizeSubs(subs);
    participantNames = normalizeParticipants(parts);

    // Default template
    defaultTemplate = { name:"Default Picks", picks: computeDefaultPicksSet(), isDefaults:true };

    // Add defaults for anyone without a submission
    const have = new Set(people.map(p=>p.name.toLowerCase()));
    participantNames.forEach(nm=>{
      if(!have.has(nm.toLowerCase())){
        people.push({ name:nm, picks:[...defaultTemplate.picks], isDefaults:true });
      }
    });

    // Sort participants by LAST NAME (defaults card still renders first separately)
    people.sort((a,b)=> lastName(a.name).localeCompare(lastName(b.name)) || a.name.localeCompare(b.name));

    renderGames();
    renderPeople();
    hookSortButtons();
  }catch(e){
    console.error(e);
    showErr('Failed to load CSV: ' + (e && e.message ? e.message : e));
  }
}

/* ========= COUNT PICKS PER GAME ========= */
function getPickCounts(qid){
  const awayNorm = normTeam(qidToAway.get(qid) || "");
  const homeNorm = normTeam(qidToHome.get(qid) || "");
  let away = 0, home = 0;

  people.forEach(p=>{
    p.picks.forEach(pk=>{
      if(pk.qid !== qid) return;
      const c = normTeam(pk.choice);
      const wt = pk.isDouble ? DOUBLE_COUNTS_AS : 1;
      if(c && c === awayNorm) away += wt;
      else if(c && c === homeNorm) home += wt;
    });
  });

  return { away, home };
}

/* ============== RENDER GAMES (defaults + any game picked) ============== */
function renderGames(){
  const panel = document.getElementById('gamesPanel');
  panel.innerHTML = '';

  // union of default QIDs and all QIDs that have at least one pick
  const pickedQids = new Set();
  people.forEach(p=>p.picks.forEach(pk=> pickedQids.add(pk.qid)));
  const defaultQids = new Set((defaultTemplate?.picks||[]).map(p=>p.qid));
  const qidsAll = new Set([...pickedQids, ...defaultQids]);

  const qids = [...qidsAll].sort((a,b)=> qidOrder(a)-qidOrder(b));

  if(qids.length === 0){
    panel.innerHTML = `<div class="note">No picks yet.</div>`;
    return;
  }

  qids.forEach(qid=>{
    const div = document.createElement('div');
    div.className = 'game';

    const away = qidToAway.get(qid) || 'Away';
    const home = qidToHome.get(qid) || 'Home';
    const counts = getPickCounts(qid);
    const lockedOutcome = outcomeFromWinner(qid);

    if(lockedOutcome){
      const winnerText = lockedOutcome==='tie' ? 'Tie' : (lockedOutcome==='away' ? away : home);
      div.innerHTML = `
        <div class="gline">${escapeHtml(qid)} — ${escapeHtml(qidToLine.get(qid) || qid)}</div>
        <div style="grid-column: 2 / span 3; font-weight:700;">
          Result: ${escapeHtml(winnerText)} (locked)
        </div>
      `;
    } else {
      div.innerHTML = `
        <div class="gline">${escapeHtml(qid)} — ${escapeHtml(qidToLine.get(qid) || qid)}</div>
        <button class="gbtn away ${results.get(qid)==='away'?'active':''}" data-qid="${qid}" data-val="away">
          ${escapeHtml(away)} <span class="count">(${counts.away})</span>
        </button>
        <button class="gbtn home ${results.get(qid)==='home'?'active':''}" data-qid="${qid}" data-val="home">
          ${escapeHtml(home)} <span class="count">(${counts.home})</span>
        </button>
        <button class="gbtn tie  ${results.get(qid)==='tie'?'active':''}"  data-qid="${qid}" data-val="tie">Tie</button>
      `;
    }
    panel.appendChild(div);
  });

  panel.onclick = (e)=>{
    const btn = e.target.closest('.gbtn');
    if(!btn) return;
    const qid = btn.dataset.qid;
    if(outcomeFromWinner(qid)) return; // locked globally

    const val = btn.dataset.val;
    const current = results.get(qid);
    if(current === val){ results.delete(qid); } else { results.set(qid, val); }

    const row = btn.closest('.game');
    row.querySelectorAll('.gbtn').forEach(b=> b.classList.remove('active'));
    if(results.has(qid)) row.querySelector(`.gbtn.${results.get(qid)}`)?.classList.add('active');

    renderPeople(); // re-score
  };
}

/* ============== SCORING ============== */
function scorePick(qid, choice, isDouble){
  const outcome = results.get(qid);
  if(!outcome) return { w:0, l:0, t:0 };

  const awayNorm = normTeam(qidToAway.get(qid) || '');
  const homeNorm = normTeam(qidToHome.get(qid) || '');
  const cNorm = normTeam(choice);

  let w=0,l=0,t=0;
  const weight = isDouble ? DOUBLE_COUNTS_AS : 1;

  if(outcome === 'tie'){
    t = weight;
  } else if(outcome === 'away'){
    if(cNorm && cNorm === awayNorm) w = weight; else l = weight;
  } else if(outcome === 'home'){
    if(cNorm && cNorm === homeNorm) w = weight; else l = weight;
  }
  return { w,l,t };
}

/* ============== RENDER PEOPLE + STANDINGS ============== */
function renderPeople(){
  const list = document.getElementById('list');
  const stWrap = document.getElementById('standingsWrap');
  list.innerHTML = '';
  const summaries = [];

  /* --- First card: Default Picks template --- */
  if (defaultTemplate && defaultTemplate.picks && defaultTemplate.picks.length){
    const rows = defaultTemplate.picks.map((pk, idx)=>{
      const s = scorePick(pk.qid, pk.choice, pk.isDouble);
      const fav = detectFavoriteFromSpread(qidToAway.get(pk.qid)||"", qidToHome.get(pk.qid)||"", qidToSpread.get(pk.qid)||"");
      const showPick = (function(){
        if(!fav) return pk.choice;
        const favName = fav.team==='home' ? qidToHome.get(pk.qid) : qidToAway.get(pk.qid);
        // include −spread only when pick is the favorite
        return (normTeam(pk.choice)===normTeam(favName)) ? `${favName} ${fav.minus}` : pk.choice;
      })();
      return `
        <tr>
          <td class="col-idx">${idx+1}</td>
          <td class="col-line">${escapeHtml(qidToLine.get(pk.qid) || pk.qid)}</td>
          <td class="col-pick">${escapeHtml(showPick)}${pk.isDouble?'<span class="double"></span>':''}</td>
          <td>${s.w? s.w : ''}</td>
          <td>${s.l? s.l : ''}</td>
          <td>${s.t? s.t : ''}</td>
        </tr>
      `;
    }).join('');

    let tw=0, tl=0, tt=0;
    defaultTemplate.picks.forEach(pk=>{
      const s = scorePick(pk.qid, pk.choice, pk.isDouble);
      tw+=s.w; tl+=s.l; tt+=s.t;
    });
    const denom = tw+tl+tt;
    const pct = denom>0 ? (tw + 0.5*tt)/denom : NaN;

    const card = document.createElement('div');
    card.className = 'person';
    card.innerHTML = `
      <div class="header">
        <div class="pname">${escapeHtml(defaultTemplate.name)}</div>
        <span class="badge-defaults">Defaults</span>
      </div>
      <table>
        <thead>
          <tr>
            <th class="col-idx">#</th>
            <th>Line</th>
            <th>Pick</th>
            <th>Win</th>
            <th>Loss</th>
            <th>Tie</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
        <tfoot>
          <tr>
            <td></td>
            <td>Total</td>
            <td class="mono">${fmtPct(pct)}</td>
            <td class="mono">${tw}</td>
            <td class="mono">${tl}</td>
            <td class="mono">${tt}</td>
          </tr>
        </tfoot>
      </table>
    `;
    list.appendChild(card);
  }

  /* --- Participant cards (last-name order already) --- */
  people.forEach(p=>{
    let rowsHtml = '';
    let tw=0, tl=0, tt=0;

    p.picks.forEach((pk, idx)=>{
      const s = scorePick(pk.qid, pk.choice, pk.isDouble);
      tw += s.w; tl += s.l; tt += s.t;

      const fav = detectFavoriteFromSpread(qidToAway.get(pk.qid)||"", qidToHome.get(pk.qid)||"", qidToSpread.get(pk.qid)||"");
      const pickDisplay = (function(){
        if(!fav) return pk.choice;
        const favName = fav.team==='home' ? qidToHome.get(pk.qid) : qidToAway.get(pk.qid);
        return (normTeam(pk.choice)===normTeam(favName)) ? `${favName} ${fav.minus}` : pk.choice;
      })();

      const cls = s.w ? 'result-win' : s.l ? 'result-loss' : s.t ? 'result-tie' : '';
      rowsHtml += `
        <tr>
          <td class="col-idx">${idx+1}</td>
          <td class="col-line">${escapeHtml(qidToLine.get(pk.qid) || pk.qid)}</td>
          <td class="col-pick ${cls}">${escapeHtml(pickDisplay)}${pk.isDouble?'<span class="double"></span>':''}</td>
          <td>${s.w? s.w : ''}</td>
          <td>${s.l? s.l : ''}</td>
          <td>${s.t? s.t : ''}</td>
        </tr>
      `;
    });

    const denom = tw + tl + tt;
    const pct = denom > 0 ? (tw + 0.5*tt) / denom : NaN;

    summaries.push({ name:p.name, w:tw, l:tl, t:tt, pct, denom, isDefaults: !!p.isDefaults });

    const table = `
      <div class="header">
        <div class="pname">${escapeHtml(p.name)}</div>
        ${p.isDefaults ? '<span class="badge-defaults" title="No submission — defaults applied">Defaults</span>' : ''}
      </div>
      <table>
        <thead>
          <tr>
            <th class="col-idx">#</th>
            <th>Line</th>
            <th>Pick</th>
            <th>Win</th>
            <th>Loss</th>
            <th>Tie</th>
          </tr>
        </thead>
        <tbody>${rowsHtml}</tbody>
        <tfoot>
          <tr>
            <td></td>
            <td>Total</td>
            <td class="mono">${fmtPct(pct)}</td>
            <td class="mono">${tw}</td>
            <td class="mono">${tl}</td>
            <td class="mono">${tt}</td>
          </tr>
        </tfoot>
      </table>
    `;

    const card = document.createElement('div');
    card.className = 'person';
    card.innerHTML = table;
    list.appendChild(card);
  });

  renderStandings(summaries);
  stWrap.hidden = summaries.length === 0;
}

/* ============== STANDINGS (sorting) ============== */
function renderStandings(summaries){
  const st = document.getElementById('standings');

  const valid = summaries.filter(s => s.denom > 0);
  if(valid.length === 0){ st.innerHTML = ""; return; }

  const rows = [...valid].sort((a,b)=>{
    if (standingsSort === 'percent'){
      const ap = isNaN(a.pct)? -1 : a.pct, bp = isNaN(b.pct)? -1 : b.pct;
      if(bp !== ap) return bp - ap;
      if(b.w !== a.w) return b.w - a.w;
      return a.name.localeCompare(b.name);
    } else if (standingsSort === 'wins'){
      if(b.w !== a.w) return b.w - a.w;
      const ap = isNaN(a.pct)? -1 : a.pct, bp = isNaN(b.pct)? -1 : b.pct;
      if(bp !== ap) return bp - ap;
      return a.name.localeCompare(b.name);
    } else { // alpha by last name
      return lastName(a.name).localeCompare(lastName(b.name)) || a.name.localeCompare(b.name);
    }
  });

  document.getElementById('sort-alpha').classList.toggle('active', standingsSort==='alpha');
  document.getElementById('sort-percent').classList.toggle('active', standingsSort==='percent');
  document.getElementById('sort-wins').classList.toggle('active', standingsSort==='wins');

  const tbody = rows.map((s, i)=>`
    <tr>
      <td class="rank">${i+1}.</td>
      <td>
        <span class="nameCell">
          ${escapeHtml(s.name)}
          ${s.isDefaults ? '<span class="badge-defaults" title="No submission — defaults applied">Defaults</span>' : ''}
        </span>
      </td>
      <td class="stat mono">${fmtPct(s.pct)}</td>
      <td class="stat mono">${s.w}-${s.l}-${s.t}</td>
      <td class="stat mono">${s.denom}</td>
    </tr>
  `).join("");

  st.innerHTML = `
    <table>
      <thead>
        <tr>
          <th class="rank">#</th>
          <th>Name</th>
          <th class="stat">Win %</th>
          <th class="stat">W-L-T</th>
          <th class="stat">Picks</th>
        </tr>
      </thead>
      <tbody>${tbody}</tbody>
    </table>
  `;
}

function hookSortButtons(){
  document.getElementById('sort-alpha').onclick   = ()=>{ standingsSort='alpha';   renderPeople(); };
  document.getElementById('sort-percent').onclick = ()=>{ standingsSort='percent'; renderPeople(); };
  document.getElementById('sort-wins').onclick    = ()=>{ standingsSort='wins';    renderPeople(); };
}

/* ============== GO ============== */
loadAll();
// setInterval(loadAll, 60000);
</script>
</body>
</html>
