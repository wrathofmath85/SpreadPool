<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" /> <title>Spread Pool — Week 1</title>

<style>
:root{
  --bg:#0d1117; --card:#111827; --text:#e6edf3; --muted:#9aa1b1; --border:#263142;
  --chip:#f2c53d; --chipText:#000; --yellow:#ffcc15; --yellowText:#000;
  --good:#1f883d; --bad:#b42318; --blue:#1f6feb; --orange:#ff7b00; } *{box-sizing:border-box} body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:16px;line-height:1.35;
}
.wrap{max-width:1150px;margin:0 auto;padding:24px}
h1{margin:0 0 18px 0;font-size:28px}
h2{margin:0 0 12px 0;font-size:20px}
.small{font-size:.92rem}.muted{color:var(--muted)}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin:12px 0} .grid{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
/* each game row */
.row{display:grid;grid-template-columns:1fr auto minmax(280px,1fr);gap:10px;align-items:center;
     padding:10px;border-radius:10px;background:rgba(255,255,255,.02);border:1px solid var(--border)} .label{font-weight:700} .details{font-size:.95rem} .chip{display:inline-flex;align-items:center;gap:8px}

/* badges */
.badge{display:inline-flex;align-items:center;justify-content:center;border-radius:999px;padding:6px 12px;font-weight:800} .badge.required{background:var(--yellow);color:#000}
.badge.expired{background:#d92d20;color:#fff}

/* answers column: vertical, single line */ .answers{display:block;max-width:34rem}
.answers label{
  display:flex;align-items:center;gap:8px;margin:6px 0;cursor:pointer;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;word-break:normal;overflow-wrap:normal;
}
.answers input{transform:translateY(1px)} .answers .clear{margin-top:8px}

/* clear button */
.clear{
  display:inline-block;background:transparent;border:1px solid #3b4553;border-radius:8px;
  color:var(--muted);padding:6px 10px;cursor:pointer } .clear:hover{background:#2a3442;color:#fff}

/* section headers: answered count pill */ .hdr{display:flex;align-items:center;justify-content:space-between}

/* footer status */
footer{position:sticky;bottom:0;left:0;right:0;z-index:9}
.footer{
  display:flex;justify-content:space-between;align-items:center;gap:8px;
  background:rgba(16,23,33,.85);backdrop-filter:blur(6px);
  border-top:1px solid var(--border);padding:10px 14px } .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.btn.primary{background:#238636;color:#fff}
.btn.ghost{background:#2a3442;color:#d0d7de}
.statusBox{font-weight:900;border:1px solid var(--border);border-radius:999px;padding:8px 14px} .status_bad{background:var(--bad);color:#fff}
.status_good{background:#0b5cab;color:#fff;border-color:#0b5cab}

/* DEMO badge */
.demo{position:fixed;top:14px;right:14px;background:#a15;box-shadow:0 6px 18px rgba(0,0,0,.35);
      color:#fff;border-radius:10px;padding:8px 12px;font-weight:800;z-index:20}

/* mobile: stack row columns, full-width answers */ @media(max-width:720px){
  .row{grid-template-columns:1fr;align-items:flex-start}
  .answers{max-width:none;width:100%}
  .answers label{width:100%}
}
</style>
</head>
<body>
<div class="wrap">

  <h1>Spread Pool — Week <span id="weekNum">1</span></h1>

  <!-- PARTICIPANT -->
  <section class="card">
    <h2>Participant</h2>
    <div class="grid">
      <div>
        <label class="small muted">Choose your name</label>
        <select id="selName" style="width:100%;padding:10px;border-radius:8px;background:#0f1621;color:var(--text);border:1px solid var(--border)">
          <option disabled selected>— Loading names… —</option>
        </select>
      </div>
      <div>
        <label class="small muted">Your email (auto-filled; editable)</label>
        <input id="inpEmail" type="email" placeholder="you@example.com"
               style="width:100%;padding:10px;border-radius:8px;background:#0f1621;color:var(--text);border:1px solid var(--border)"/>
        <p class="small muted" style="margin:.5rem 0 0">One email is sent to the organizer and you’ll be CC’d.</p>
      </div>
    </div>
  </section>

  <div class="grid">
    <!-- NFL -->
    <section class="card">
      <div class="hdr">
        <h2>NFL (Section A)</h2>
        <span id="cntA" class="small muted">Answered: 0</span>
      </div>
      <div id="listA"><p class="small muted">Loading NFL…</p></div>
    </section>

    <!-- NCAA -->
    <section class="card">
      <div class="hdr">
        <h2>College (Section B)</h2>
        <span id="cntB" class="small muted">Answered: 0</span>
      </div>
      <div id="listB"><p class="small muted">Loading NCAA…</p></div>
    </section>
  </div>

  <!-- DOUBLE -->
  <section class="card">
    <h2>Optional: Choose ONE “Double”</h2>
    <select id="selDouble" style="width:100%;max-width:560px;padding:10px;border-radius:8px;background:#0f1621;color:var(--text);border:1px solid var(--border)">
      <option value="">— No double —</option>
    </select>
    <p class="small muted">Only your currently selected, unexpired games appear here.</p>
  </section>

  <!-- CHECKS -->
  <section class="card">
    <h2>Checks &amp; Errors</h2>
    <p class="small muted">Rules: select your name &amp; valid email; answer all games marked
      <span class="badge required">Required</span>; ≥3 in NFL and ≥3 in College; total 7–12 picks.
      If you choose a Double, it must be one of your selections.</p>
    <ul id="errList" class="small" style="margin:8px 0 0 18px"></ul>
  </section>

  <!-- SUMMARY -->
  <section class="card">
    <h2>Summary of Chosen Answers</h2>
    <div id="summary"><p class="small muted">Your selections will appear here.</p></div>
  </section>

  <!-- FOOTER -->
  <footer>
    <div class="footer">
      <div class="left">
        <button id="submitBtn" class="btn primary">Submit</button>
        <button id="resetBtn"  class="btn ghost">Reset</button>
      </div>
      <div class="right">
        <span id="statusBox" class="statusBox status_bad">ERRORS DETECTED</span>
      </div>
    </div>
  </footer>

  <div id="demoBadge" class="demo" hidden>DEMO MODE</div>

</div>

<script>
/* =====================  CONFIG  ===================== */ // Replace with your Publish-to-web CSV links 
const CSV_URL_PARTICIPANTS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTfQ7a2weK5Got7LTe3yVxqhcPR6pa-nPg73PdOMk8rrHwqlr3UeTcPprlgVbFjhFIVpifmMKnb_Tss/pub?gid=0&single=true&output=csv"; // Name, Email
const CSV_URL_NFL          = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSu8cw2ymTbcJGMmBkbcJTNzvxVsl4wh3XH7pbQJ3_pbSz42LFo0HKQHVLcJtHiOqtEDt37-hSegjDK/pub?gid=2109553148&single=true&output=csv";          // Away Team, Home Team, Date, Time, TV, Location, Spread, Required
const CSV_URL_NCAA         = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSu8cw2ymTbcJGMmBkbcJTNzvxVsl4wh3XH7pbQJ3_pbSz42LFo0HKQHVLcJtHiOqtEDt37-hSegjDK/pub?gid=0&single=true&output=csv";


// Week #
const CURRENT_WEEK = 1;
document.getElementById("weekNum").textContent = CURRENT_WEEK;

// EmailJS (flip DEMO_MODE=false to actually send)
const DEMO_MODE            = true;  // true = no email sent; UI still says "Submitted"
const EMAILJS_SERVICE_ID  = "service_txqdfck"; 
const EMAILJS_TEMPLATE_ID = "template_o8du7pt"; 
const EMAILJS_PUBLIC_KEY  = "w4UC6ofDTC0VdRI44";
const ORGANIZER_EMAIL     = "wrathofmath85@gmail.com";

/* =====================  HELPERS  ===================== */ const $ = s => document.querySelector(s); const $$ = s => Array.from(document.querySelectorAll(s));
const localTZ = Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";

function cacheBusted(url){
  const u = new URL(url); u.searchParams.set("_", String(Date.now())); return u.toString(); } function escapeHtml(s){ return String(s ?? "").replace(/[&<>"]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m])); }

// CSV -> array of objects
async function fetchCSV(url){
  const res = await fetch(cacheBusted(url), {headers:{pragma:"no-cache","cache-control":"no-cache"}});
  const txt = await res.text();
  const rows = parseCSV(txt);
  const [hdr, ...data] = rows;
  return data.filter(r => r.some(cell => (cell??"").trim()!=="")).map(r=>{
    const obj={}; hdr.forEach((h,i)=>obj[h.trim()]= (r[i]??"").trim()); return obj;
  });
}
function parseCSV(text){
  const rows=[], re = /(?:^|,)(?:"([^"]*(?:""[^"]*)*)"|([^",\n\r]*))/g;
  let row=[], m;
  const lines = text.replace(/\r\n/g,"\n").split("\n");
  for(const line of lines){
    row=[]; re.lastIndex=0;
    while((m=re.exec(line))!==null) row.push( m[1] ? m[1].replace(/""/g,'"') : (m[2]??"") );
    rows.push(row);
  }
  return rows;
}

/* -------- Time parsing (CSV Date/Time are Eastern) -------- */ const ET_TZ = "America/New_York";

function parseMDY(dateStr){
  if(!dateStr) return null;
  // Try native first
  let d = new Date(dateStr);
  if(!isNaN(d)) return { y:d.getFullYear(), m:d.getMonth()+1, d:d.getDate() };
  // 9/5/2025
  let m = dateStr.match(/^\s*(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\s*$/);
  if(m) return { m:+m[1], d:+m[2], y:+m[3] };
  // Sept 5, 2025  / Sep 5, 2025
  m = dateStr.match(/^\s*([A-Za-z]+)\s+(\d{1,2}),\s*(\d{4})\s*$/);
  if(m){
    const months={"jan":1,"feb":2,"mar":3,"apr":4,"may":5,"jun":6,"jul":7,"aug":8,"sep":9,"sept":9,"oct":10,"nov":11,"dec":12};
    const mm = months[m[1].slice(0,4).toLowerCase()];
    if(mm) return { m:mm, d:+m[2], y:+m[3] };
  }
  return null;
}
function parseTime12h(s){
  if(!s) return null;
  const m = s.match(/^\s*(\d{1,2}):(\d{2})\s*([AP]M)\s*$/i);
  if(!m) return null;
  let h = (+m[1])%12; if(m[3].toUpperCase()==='PM') h+=12;
  return { h, mi:+m[2] };
}

/* Convert a local wall-time in a timeZone to a real Date (UTC-ms) */ function makeDateInTZ(y,m,d,h,mi,tz){
  // Start with a UTC guess at the same numeric components
  const guess = new Date(Date.UTC(y,m-1,d,h,mi||0,0,0));
  // What *local* (tz) wall-time does that instant show?
  const dtf = new Intl.DateTimeFormat('en-US',{
    timeZone: tz, hour12:false, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'
  });
  const parts = Object.fromEntries(dtf.formatToParts(guess).map(p=>[p.type,p.value]));
  // Convert those parts back to a "UTC wall" (no timezone) ms
  const asLocalMs = Date.UTC(+parts.year, +parts.month-1, +parts.day, +parts.hour, +parts.minute);
  // Our target local wall is y-m-d h:mi; delta tells us how far to move the UTC guess
  const wantedLocalMs = Date.UTC(y,m-1,d,h,mi||0);
  const diff = asLocalMs - wantedLocalMs;
  return new Date(guess.getTime() - diff); }

/* Format helpers in user's local TZ */
const fmtDayLocal  = ms => new Intl.DateTimeFormat('en-US',{weekday:'long', timeZone:localTZ}).format(ms); const fmtTimeLocal = ms => new Intl.DateTimeFormat('en-US',{hour:'numeric', minute:'2-digit', hour12:true, timeZone:localTZ}).format(ms);

/* -------- Normalize games: build display + deadline -------- */ function normalizeGames(arr){
  const keep = arr.filter(r => (r["Spread"]??"").toString().trim() !== "");
  // Required to top
  keep.sort((a,b)=>((b["Required"]==="Y")-(a["Required"]==="Y")));

  return keep.map((r, idx)=>{
    const away = String(r["Away Team"]||"").trim();
    const home = String(r["Home Team"]||"").trim();
    const tv   = String(r["TV"]||"").trim();
    const loc  = String(r["Location"]||"").trim();
    const fav  = String(r["Spread"]||"").trim(); // e.g., "Eagles -6.5"
    const dateStr = String(r["Date"]||"").trim();
    const timeStr = String(r["Time"]||"").trim();

    // favorite labeling
    let favTeam="", favNum="";
    if(fav && fav.includes(" ")){ const sp=fav.split(/\s+/); favTeam=sp.slice(0,sp.length-1).join(" "); favNum=sp[sp.length-1]; }
    const awayLab = away + (away===favTeam ? ` ${favNum}` : "");
    const homeLab = home + (home===favTeam ? ` ${favNum}` : "");

    // Convert CSV Eastern date+time to an actual moment, then show in user's TZ
    let ms=null;
    const dParts = parseMDY(dateStr), tParts = parseTime12h(timeStr);
    if(dParts && tParts){
      ms = makeDateInTZ(dParts.y, dParts.m, dParts.d, tParts.h, tParts.mi, ET_TZ).getTime();
    }
    const dispDay  = ms ? fmtDayLocal(ms)  : (dateStr||"—");
    const dispTime = ms ? fmtTimeLocal(ms) : (timeStr||"—");

    //


