
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>2025 Entry Form – Week 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <style>
    :root{
      --bg:#0b1324; --card:#0f172a; --text:#e5e7eb; --muted:#93a1b1;
      --border:#1f2937; --chip:#1f2937; --accent:#2563eb;
      --ok:#0ea250; --bad:#b00020; --yellow:#facc15; --yellowText:#000;
      --footer-bg:rgba(11,19,36,.92);
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      font-size:14px; line-height:1.35;
      padding-bottom:88px;
    }
    h1{margin:12px 16px}
    .wrap{max-width:1100px;margin:0 auto;padding:0 16px 40px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0}
    .muted{color:var(--muted)} .small{font-size:.9rem}
    input,select{background:transparent;color:var(--text);border:1px solid var(--border);border-radius:9px;padding:8px;width:100%}
    .grid2{display:grid;gap:14px;grid-template-columns:1fr}
    @media (min-width:720px){ .grid2{grid-template-columns:1fr 1fr} }
    .row{display:grid;grid-template-columns:1fr auto auto auto;gap:10px;align-items:center;padding:8px;border-radius:10px}
    .row:nth-child(odd){background:rgba(255,255,255,.03)}
    .label{font-weight:700}
    .details{font-size:.9rem;line-height:1.25rem;margin-top:4px}
    .details div{margin:1px 0}
     /* Vertical radio options */
    .answers{display:block}
    .answers label{
     display:flex;            /* radio + text on one line */
     gap:8px;
     align-items:center;
     margin:4px 0;            /* space between choices */
     cursor:pointer;
     }
    .clear{border:1px solid var(--border);background:transparent;color:var(--muted);border-radius:7px;padding:5px 9px;cursor:pointer}
    .clear:hover{color:#fff;border-color:#334155}
    .chip{display:inline-block;background:var(--chip);border-radius:999px;padding:2px 10px;font-size:.8rem}
    .chip.mandatory{background:var(--yellow);color:var(--yellowText);font-weight:800;border:1px solid #eab308}
    .chip.expired{opacity:.7}
    .expired{opacity:.55}
    .hdr{display:flex;gap:10px;align-items:baseline;justify-content:space-between}
    .counts{display:inline-flex;gap:8px}
    footer{
      position:fixed; bottom:0; left:0; right:0; z-index:9999;
      background:var(--footer-bg); backdrop-filter:blur(6px);
      border-top:1px solid var(--border); padding:10px 14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    #statusBox{font-weight:900;border:1px solid var(--border);border-radius:10px;padding:8px 12px}
    #statusBox.bad{background:#7f1d1d;color:#fff}
    #statusBox.good{background:#1e3a8a;color:#ffa500}
    .footer-actions{display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    #err{display:none;color:#fee;background:#3b0f0f;border-color:#7f1d1d}
    /* Make pick options vertical instead of horizontal */
    .game .options label {
     display: block;
     margin: 4px 0;
     }
    .clearBtn {
     display: block;      /* puts it on its own line */
     margin-top: 6px;     /* space above */
     margin-left: 0;      /* align with choices */
     }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Spread Pool — Week <span id="wkLbl">1</span></h1>

    <div id="err" class="card"></div>

    <section class="card">
      <h2>Participant</h2>
      <div class="grid2">
        <div>
          <div class="small muted">Choose your name</div>
          <select id="nameSel"><option value="">— Loading names… —</option></select>
        </div>
        <div>
          <div class="small muted">Your email (auto-filled; editable)</div>
          <input id="emailInp" type="email" placeholder="you@example.com" />
        </div>
      </div>
      <p class="small muted">One email is sent to the organizer and you’ll be CC’d.</p>
    </section>

    <div class="grid2">
      <section class="card">
        <div class="hdr">
          <h2>NFL</h2>
          <div class="counts"><span id="countA" class="chip">Answered: 0</span></div>
        </div>
        <div id="listA" class="qList"><p class="small muted">Loading NFL…</p></div>
      </section>

      <section class="card">
        <div class="hdr">
          <h2>College</h2>
          <div class="counts"><span id="countB" class="chip">Answered: 0</span></div>
        </div>
        <div id="listB" class="qList"><p class="small muted">Loading NCAA…</p></div>
      </section>
    </div>

    <section class="card">
      <h2>Optional: Choose ONE “Double”</h2>
      <select id="doubleSel"><option value="">— No double —</option></select>
      <p class="small muted">Only your currently selected, unexpired games appear here.</p>
    </section>

    <section class="card">
      <h2>Checks & Errors</h2>
      <ul id="errorListPanel" class="small"></ul>
      <p class="small muted">Rules: select your name & valid email; answer all games marked <span class="chip mandatory">Required</span>; ≥3 in NFL and ≥3 in College; total 7–12 picks. If you choose a Double, it must be one of your selected answers.</p>
    </section>

    <section class="card">
      <h2>Summary of Chosen Answers</h2>
      <div id="summary"><p class="small muted">Your selections will appear here.</p></div>
    </section>
  </div>

  <footer>
    <div class="footer-actions">
      <button id="submitBtn" class="btn">Submit</button>
      <button id="resetBtn" class="btn ghost">Reset</button>
    </div>
    <div id="statusBox" class="bad">ERRORS DETECTED</div>
  </footer>

<script>
/* ===================== CONFIG ===================== */ const CSV_URL_PARTICIPANTS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTfQ7a2weK5Got7LTe3yVxqhcPR6pa-nPg73PdOMk8rrHwqlr3UeTcPprlgVbFjhFIVpifmMKnb_Tss/pub?gid=0&single=true&output=csv"; // Name, Email
const CSV_URL_NFL          = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSu8cw2ymTbcJGMmBkbcJTNzvxVsl4wh3XH7pbQJ3_pbSz42LFo0HKQHVLcJtHiOqtEDt37-hSegjDK/pub?gid=2109553148&single=true&output=csv";          // Away Team, Home Team, Date, Time, TV, Location, Spread, Required
const CSV_URL_NCAA         = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSu8cw2ymTbcJGMmBkbcJTNzvxVsl4wh3XH7pbQJ3_pbSz42LFo0HKQHVLcJtHiOqtEDt37-hSegjDK/pub?gid=0&single=true&output=csv";
const CURRENT_WEEK = 1;

const EMAILJS_SERVICE_ID  = "service_txqdfck"; const EMAILJS_TEMPLATE_ID = "template_o8du7pt"; const EMAILJS_PUBLIC_KEY  = "w4UC6ofDTC0VdRI44";
const ORGANIZER_EMAIL     = "wrathofmath85@gmail.com";

/* ===================== UTIL & DIAGNOSTICS ===================== */ const $ = s => document.querySelector(s); const escapeHtml = s => String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
function showErr(msg){ const box=$("#err"); box.style.display=msg?"block":"none"; box.innerHTML=msg||""; } function setStatus(ok){ const box=$("#statusBox"); if(ok){box.textContent="BEAR DOWN!"; box.classList.remove('bad'); box.classList.add('good');} else {box.textContent="ERRORS DETECTED"; box.classList.remove('good'); box.classList.add('bad');} } function okStatus(resp){ return resp && (resp.status===200 || resp.ok); }

async function fetchCSV(url){
  const full = url + (url.includes('?') ? '&' : '?') + 'cb=' + Date.now();
  try{
    const resp = await fetch(full, { mode:'cors' });
    if(!okStatus(resp)){
      const t = await resp.text().catch(()=> '');
      showErr(`Bad HTTP status ${resp.status} for:<br><code>${escapeHtml(full)}</code><br><br>First bytes:<pre>${escapeHtml(t.slice(0,300))}</pre>`);
      throw new Error('Bad HTTP status '+resp.status);
    }
    const text = await resp.text();
    if(/<!doctype html>|<html/i.test(text)){
      showErr(`Got HTML instead of CSV for:<br><code>${escapeHtml(full)}</code><br><br>Use <b>File → Share → Publish to the web</b> → CSV.`);
      throw new Error('HTML returned, not CSV');
    }
    const parsed = Papa.parse(text, { header:true, skipEmptyLines:true, dynamicTyping:false });
    return parsed.data || [];
  }catch(e){
    console.error('[fetchCSV] error', e);
    if(!$("#err").innerHTML) showErr(`Network/parse error for:<br><code>${escapeHtml(full)}</code><br><br><b>${escapeHtml(e.message||e)}</b>`);
    throw e;
  }
}

/* ===================== DATES ===================== */ function toISO(dateStr,timeStr){
  const s=[dateStr,timeStr].filter(Boolean).join(' ');
  const d=new Date(s); if(isNaN(+d)) return "";
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'),
        h=String(d.getHours()).padStart(2,'0'), mi=String(d.getMinutes()).padStart(2,'0');
  return `${y}-${m}-${da}T${h}:${mi}`;
}
function dayName(dateStr){ const d=new Date(dateStr); return isNaN(+d)?'':d.toLocaleDateString(undefined,{weekday:'long'}); } function isExpired(iso){ if(!iso) return false; const d=new Date(iso); return !isNaN(+d) && (new Date()>d); } function normQOrder(q){ if(!q) return 9999; const s=q[0], n=parseInt(q.slice(1),10); return (s==='A'?0:1)*1000 + (isFinite(n)?n:999); }

/* ===================== PARTICIPANTS ===================== */ const nameSel=$("#nameSel"), emailInp=$("#emailInp"); function populateParticipants(rows){
  const map={}, names=[];
  rows.forEach(r=>{
    const nm = String(r.Name ?? r.name ?? "").trim();
    if(!nm) return;
    names.push(nm);
    const em = String(r.Email ?? r.email ?? "").trim();
    if(em) map[nm]=em;
  });
  names.sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));
  nameSel.innerHTML = `<option value="">— Select your name —</option>` + names.map(n=>`<option>${escapeHtml(n)}</option>`).join('');
  nameSel.onchange = ()=>{ const nm=nameSel.value.trim(); if(map[nm]) emailInp.value=map[nm]; onAnyChange(); }; }

/* ===================== GAMES ===================== */ function escRx(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

/* Attach spread ONLY if it starts with the full team name followed by space and '(' or '-' */ function spreadOnExactTeam(team, spreadText){
  if(!team || !spreadText) return team;
  const rx = new RegExp("^" + escRx(team) + "\\s*[(-]", "i"); // e.g., "Iowa (-3)" or "Iowa -3"
  if(rx.test(spreadText)){
    const m = spreadText.match(rx)[0];
    const rest = spreadText.slice(m.length-1).trim(); // keep leading "(" or "-" included
    return rest ? `${team} ${rest}` : team;
  }
  return team;
}

function favoriteFrom(awayChoice, homeChoice){
  const aFav = /(^|[ (])-\d/.test(awayChoice);
  const hFav = /(^|[ (])-\d/.test(homeChoice);
  if(aFav && !hFav) return awayChoice;
  if(hFav && !aFav) return homeChoice;
  return "";
}

function normalizeGames(rows){
  const arr=[];
  rows.forEach(r=>{
    const away=String(r["Away Team"]||r["Away"]||"").trim();
    const home=String(r["Home Team"]||r["Home"]||"").trim();
    const date=String(r["Date"]||"").trim();
    const time=String(r["Time"]||"").trim();
    const tv  =String(r["TV"]||"").trim();
    const loc =String(r["Location"]||"").trim();
    const spread=String(r["Spread"]||"").trim();
    const req =String(r["Required"]||"").trim().toUpperCase()==='Y';
    if(!spread) return;
    const iso = toISO(date,time);
    const day = dayName(date);
    const awayChoice = spreadOnExactTeam(away, spread);
    const homeChoice = spreadOnExactTeam(home, spread);
    const fav = favoriteFrom(awayChoice, homeChoice);
    arr.push({
      line:`${away} @ ${home}`, fav, day, time, tv, loc,
      deadline:iso, req, choices:[awayChoice,homeChoice]
    });
  });
  return [...arr.filter(x=>x.req), ...arr.filter(x=>!x.req)]; }

function buildRow(q, qid){
  const el=document.createElement('div');
  el.className='row'; el.dataset.qid=qid; el.dataset.deadline=q.deadline||'';
  const answers=q.choices.map(c=>`<label><input type="radio" name="${qid}" value="${escapeHtml(c)}"> ${escapeHtml(c)}</label>`).join('');
  el.innerHTML = `
    <div>
      <div class="label">${escapeHtml(q.line)}</div>
      <div class="details">
        <div><strong>Favorite:</strong> ${escapeHtml(q.fav || '—')}</div>
        <div><strong>Day:</strong> ${escapeHtml(q.day || '—')}</div>
        <div><strong>Time:</strong> ${escapeHtml(q.time || '—')}</div>
        <div><strong>Channel:</strong> ${escapeHtml(q.tv || '—')}</div>
        <div><strong>Location:</strong> ${escapeHtml(q.loc || '—')}</div>
      </div>
    </div>
    <div>${q.req?'<span class="chip mandatory">Required</span>':''}</div>
    <div class="answers">${answers}</div>
    <div><button type="button" class="clear" data-clear="${qid}">Clear</button></div>
  `;
  return el;
}
function renderSection(container, rows, prefix){
  container.innerHTML='';
  const games=normalizeGames(rows);
  if(!games.length){
    container.innerHTML = `<p class="small muted">No games found (check sheet headers and “Spread” column).</p>`;
    return;
  }
  games.forEach((g,i)=> container.appendChild(buildRow(g, `${prefix}${i+1}`))); }

/* ===================== STATE / UI ===================== */ const listA=$("#listA"), listB=$("#listB"), doubleSel=$("#doubleSel");

function allRows(){ return Array.from(document.querySelectorAll('.row')); } function answersMap(){
  const map=new Map();
  allRows().forEach(r=>{
    const id=r.dataset.qid, chk=r.querySelector('input[type=radio]:checked');
    if(chk) map.set(id,{label:r.querySelector('.label')?.textContent||id, value:chk.value, deadline:r.dataset.deadline||''});
  });
  return map;
}
function countAB(map){ let a=0,b=0; for(const k of map.keys()){ if(k.startsWith('A')) a++; else if(k.startsWith('B')) b++; } return {a,b,total:a+b}; } function refreshCounts(){ const m=answersMap(); const {a,b}=countAB(m); $("#countA").textContent=`Answered: ${a}`; $("#countB").textContent=`Answered: ${b}`; } function refreshExpiry(){
  allRows().forEach(r=>{
    const ex=isExpired(r.dataset.deadline);
    r.classList.toggle('expired',ex);
    r.querySelectorAll('input[type=radio]').forEach(i=> i.disabled=ex);
    const has=r.querySelector('.chip.expired');
    if(ex && !has){ const sp=document.createElement('span'); sp.className='chip expired'; sp.textContent='Expired'; r.children[1].insertAdjacentElement('afterend',sp); }
    else if(!ex && has){ has.remove(); }
  });
}
function enforceMax(max=12){
  const m=answersMap(); if(m.size<max){
    allRows().forEach(r=>{
      const ex=r.classList.contains('expired');
      r.querySelectorAll('input[type=radio]').forEach(i=> i.disabled=ex);
    }); return;
  }
  allRows().forEach(r=>{
    const id=r.dataset.qid, selected=m.has(id);
    r.querySelectorAll('input[type=radio]').forEach(i=>{ if(!selected && !i.checked) i.disabled=true; });
  });
}
function refreshDouble(){
  const m=answersMap(); const keep=doubleSel.value;
  doubleSel.innerHTML='<option value="">— No double —</option>';
  const ids=Array.from(m.keys()).sort((a,b)=>normQOrder(a)-normQOrder(b));
  ids.forEach(id=>{
    if(isExpired(m.get(id).deadline)) return;
    const opt=document.createElement('option'); opt.value=id; opt.textContent=`${id} — ${m.get(id).label}`; doubleSel.appendChild(opt);
  });
  if(keep && m.has(keep)) doubleSel.value=keep; else doubleSel.value=''; } function updateSummary(){
  const m=answersMap(); if(m.size===0){ $("#summary").innerHTML='<p class="small muted">Your selections will appear here.</p>'; return; }
  const A=[],B=[]; for(const [id,o] of m) (id.startsWith('A')?A:B).push({id, ...o});
  A.sort((x,y)=>normQOrder(x.id)-normQOrder(y.id)); B.sort((x,y)=>normQOrder(x.id)-normQOrder(y.id));
  const dbl = doubleSel.value;
  const ul = (t,arr)=>`<h3>${t}</h3>${arr.length?`<ol style="margin:.3rem 0 0;padding-left:18px">${arr.map(x=>`<li><strong>${escapeHtml(x.label)}</strong>: ${escapeHtml(x.value)}${dbl===x.id?' <span class="chip">[DOUBLE]</span>':''}</li>`).join('')}</ol>`:'<p class="small muted">None selected.</p>'}`;
  $("#summary").innerHTML = ul('NFL',A) + ul('College',B); } function validateAll(){
  const errs=[]; const name=nameSel.value.trim(); const em=emailInp.value.trim();
  const m=answersMap(); const {a,b,total}=countAB(m);
  const mandA=$("#listA .row .mandatory")?.closest('.row')?.dataset.qid||null;
  const mandB=$("#listB .row .mandatory")?.closest('.row')?.dataset.qid||null;
  const checks=[];

  if(name) checks.push('✅ Name selected'); else { checks.push('❌ Name not selected'); errs.push('Choose your name.'); }
  if(em && /\S+@\S+\.\S+/.test(em)) checks.push('✅ Valid email'); else { checks.push('❌ Email missing/invalid'); errs.push('Enter a valid email.'); }

  if(!mandA || m.has(mandA)) checks.push('✅ Required NFL picked'); else { checks.push('❌ Required NFL not picked'); errs.push('Pick the required NFL game.'); }
  if(!mandB || m.has(mandB)) checks.push('✅ Required College picked'); else { checks.push('❌ Required College not picked'); errs.push('Pick the required College game.'); }

  if(a>=3) checks.push('✅ ≥3 NFL'); else { checks.push(`❌ Only ${a} NFL`); errs.push('Pick at least 3 NFL games.'); }
  if(b>=3) checks.push('✅ ≥3 College'); else { checks.push(`❌ Only ${b} College`); errs.push('Pick at least 3 College games.'); }

  if(total>=7 && total<=12) checks.push(`✅ Total 7–12 (now ${total})`);
  else { if(total<7){ checks.push(`❌ Too few (${total}/7)`); errs.push('Pick at least 7 total.'); }
         if(total>12){ checks.push(`❌ Too many (${total}/12)`); errs.push('Max 12 picks.'); } }

  const dbl=doubleSel.value;
  if(dbl){ if(m.has(dbl)) checks.push(`✅ Double valid (${dbl})`); else { checks.push('❌ Double not among selections'); errs.push('Double must be one of your selected answers.'); } }
  else checks.push('ℹ️ No double selected (optional)');

  const ul1=$("#errorListPanel"); ul1.innerHTML='';
  checks.forEach(c=>{
    const li=document.createElement('li'); li.textContent=c;
    li.style.color=c.startsWith('❌')?'var(--bad)':c.startsWith('✅')?'var(--ok)':'var(--muted)';
    ul1.appendChild(li);
  });

  setStatus(errs.length===0);
  return { valid: errs.length===0, name, email:em, answers:m, doubleId:dbl }; } function buildEmailText(name,email,m,did){
  const ts=new Date().toISOString();
  const keys=Array.from(m.keys()).sort((a,b)=>normQOrder(a)-normQOrder(b));
  const lines=[`Name: ${name}`,`Email: ${email}`,`Week: ${CURRENT_WEEK}`,`Timestamp: ${ts}`,'','Selections:'];
  keys.forEach(k=>{ const v=m.get(k).value; const dbl=(did&&did===k)?' [DOUBLE]':''; lines.push(`${k}:${v}${dbl}`); });
  return lines.join('\n');
}
function onAnyChange(){ refreshExpiry(); refreshCounts(); enforceMax(12); refreshDouble(); updateSummary(); validateAll(); }

/* ===================== WIRING ===================== */ document.addEventListener('change', e=>{
  if(e.target.matches('#nameSel,#emailInp,input[type=radio],#doubleSel')) onAnyChange(); }); document.addEventListener('click', e=>{
  if(e.target.matches('[data-clear]')){
    const id=e.target.getAttribute('data-clear');
    document.querySelectorAll(`input[name="${id}"]`).forEach(i=> i.checked=false);
    onAnyChange();
  }
});
$("#resetBtn").onclick=()=>{
  nameSel.value=''; emailInp.value=''; doubleSel.value='';
  document.querySelectorAll('input[type=radio]').forEach(i=> i.checked=false);
  onAnyChange(); window.scrollTo({top:0,behavior:'smooth'});
};

/* ===================== LOAD & SUBMIT ===================== */ document.addEventListener('DOMContentLoaded', async ()=>{
  $("#wkLbl").textContent = CURRENT_WEEK;
  if (EMAILJS_PUBLIC_KEY && window.emailjs) { emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY }); }
  try{
    const [parts,nfl,ncaa] = await Promise.all([
      fetchCSV(CSV_URL_PARTICIPANTS),
      fetchCSV(CSV_URL_NFL),
      fetchCSV(CSV_URL_NCAA)
    ]);
    populateParticipants(parts);
    renderSection($("#listA"), nfl,  'A');
    renderSection($("#listB"), ncaa, 'B');
    onAnyChange();
    setInterval(onAnyChange, 60000);
  }catch(e){
    console.error('[load] fatal', e);
  }
});

// Footer SUBMIT button (with "no double" confirmation)
$("#submitBtn").onclick = async () => {
 const s = validateAll();
 if (!s.valid) {
   alert('Please fix the items shown in the Checks & Errors card.');
   return;
 }
 // If valid but no Double, ask for confirmation
 if (!s.doubleId) {
   const ok = confirm(
     "You did not select a Double.\n\nAre you sure you want to submit without a Double?"
   );
   if (!ok) return; // let them go back and choose one
 }
 $("#submitBtn").disabled = true;
 try {
   await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
     organizer_email: ORGANIZER_EMAIL,
     participant_name: s.name,
     participant_email: s.email,
     selections_text: buildEmailText(s.name, s.email, s.answers, s.doubleId)
   });
   alert('Submitted!');
 } catch (err) {
   console.error('Email send failed', err);
   alert('Email send failed. Please try again.');
 } finally {
   $("#submitBtn").disabled = false;
 }
};
</script> </body> </html> 

