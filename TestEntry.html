<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" /> <title>Spread Pool — Week 1</title>

<!-- ======== STYLE ======== -->
<style>
:root{
  --bg:#0b1324; --card:#172a3a; --chip:#e0e0e0; --muted:#9aa1b1;
  --text:#eaf1ff; --accent:#2563eb; --border:#1f3346;
  --good:#1f9d55; --bad:#b91c1c;
  --yellow:#ffcc15; --yellowText:#000;
  --bearsBlue:#0b162a; --bearsOrange:#dc4405; }

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--text);
  font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  font-size:16px; line-height:1.35;
}
.wrap{max-width:1100px;margin:0 auto;padding:24px 16px 96px}
h1{margin:0 0 16px 0}
h2{margin:0 0 8px 0}
.small{font-size:.9rem}
.small.muted{color:var(--muted)}
.card{
  background:var(--card); border:1px solid var(--border);
  border-radius:12px; padding:14px 16px; margin:14px 0; } .grid{
  display:grid; grid-template-columns:1fr; gap:16px; align-items:start; } @media (min-width: 920px){
  .grid{grid-template-columns:1fr 1fr}
}
.sectionHead{
  display:flex; gap:12px; align-items:center; justify-content:space-between;
  margin-bottom:4px;
}
.kpi{background:rgba(255,255,255,.07); padding:.3rem .7rem; border-radius:999px} .row{
  border:1px solid var(--border); border-radius:12px; padding:12px 12px 10px; margin:10px 0;
  display:flex; flex-direction:column; gap:8px; } .label{font-weight:700; margin-bottom:4px} .details{display:grid; grid-template-columns:auto; gap:2px} .details div{white-space:nowrap; overflow:hidden; text-overflow:ellipsis} .answers{display:flex; flex-direction:column; gap:6px; margin-top:6px} .answers label{
  display:flex; gap:10px; align-items:center; cursor:pointer; user-select:none; } .clear{align-self:flex-start; margin-top:8px} .btn{
  border:0; padding:.6rem 1rem; border-radius:10px; cursor:pointer;
  background:#2a3f55; color:var(--text); font-weight:700; } .btn.ghost{
  background:transparent; border:1px solid var(--border); color:var(--muted) } .btn:disabled{opacity:.6; cursor:not-allowed} .chip{
  display:inline-flex; align-items:center; gap:.35rem;
  padding:.2rem .6rem; border-radius:999px; border:1px solid var(--border);
  background:rgba(255,255,255,.08); color:var(--text); font-weight:700;
  font-size:.82rem;
}
.chip.mandatory{background:var(--yellow); color:var(--yellowText); border-color:#eab308} .chip.expired{background:#ffe4e6; color:#7f1d1d; border-color:#fecdd3}

footer{
  position:fixed; left:0; right:0; bottom:0; z-index:99;
  backdrop-filter: blur(6px);
}
.footerWrap{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  max-width:1100px; margin:0 auto; padding:12px 16px; } .statusBox{
  font-weight:900; border:1px solid var(--border);
  border-radius:12px; padding:10px 14px; display:inline-flex; align-items:center; } .status_bad{background:var(--bad); color:#fff} .status_good{background:var(--bearsBlue); color:var(--bearsOrange)} /* Bears colors */ .controls{display:flex; gap:8px} .controls .btn{padding:.7rem 1.1rem}

select, input[type="email"]{
  width:100%; background:transparent; color:var(--text);
  border:1px solid var(--border); border-radius:10px; padding:.6rem .7rem; } label[for="nameSel"], label[for="emailBox"]{display:block; margin-bottom:6px}

.note{margin-top:6px}

.badgeRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px} .requiredHolder{margin-top:6px} </style> </head> <body>
  <div class="wrap">
    <h1>Spread Pool — Week 1</h1>

    <!-- Participant -->
    <section class="card">
      <div class="sectionHead">
        <h2>Participant</h2>
      </div>
      <div class="grid">
        <div>
          <label for="nameSel" class="small">Choose your name</label>
          <select id="nameSel" aria-label="Choose your name">
            <option value="">— Select your name —</option>
          </select>
          <div class="note small muted">One email is sent to the organizer and you’ll be CC’d.</div>
        </div>
        <div>
          <label for="emailBox" class="small">Your email (auto-filled; editable)</label>
          <input id="emailBox" type="email" placeholder="you@example.com" />
        </div>
      </div>
    </section>

    <!-- Two columns -->
    <div class="grid">
      <!-- NFL -->
      <section class="card" id="nflCard">
        <div class="sectionHead">
          <h2>NFL (Section A)</h2>
          <span class="kpi small" id="nflCount">Answered: 0</span>
        </div>
        <div id="nflList" class="list"></div>
      </section>

      <!-- NCAA -->
      <section class="card" id="ncaaCard">
        <div class="sectionHead">
          <h2>College (Section B)</h2>
          <span class="kpi small" id="ncaaCount">Answered: 0</span>
        </div>
        <div id="ncaaList" class="list"></div>
      </section>
    </div>

    <!-- Double -->
    <section class="card">
      <h2 class="small">Optional: Choose ONE “Double”</h2>
      <select id="doubleSel">
        <option value="">— No double —</option>
      </select>
      <div class="small muted" style="margin-top:6px">Only your currently selected, unexpired games appear here.</div>
    </section>

    <!-- Checks -->
    <section class="card">
      <h2>Checks & Errors</h2>
      <p class="small muted">
        Rules: select your name & valid email; answer all games marked
        <span class="chip mandatory">Required</span>; ≥3 in NFL and ≥3 in College; total 7–12 picks.
        If you choose a Double, it must be one of your selections.
      </p>
      <ul id="errorList" class="small"></ul>
    </section>

    <!-- Summary -->
    <section class="card">
      <h2>Summary of Chosen Answer(s)</h2>
      <div id="summary" class="small muted">Your selections will appear here.</div>
    </section>
  </div>

  <!-- Footer -->
  <footer>
    <div class="footerWrap">
      <div class="controls">
        <button id="submitBtn" class="btn">Submit</button>
        <button id="resetBtn"  class="btn ghost">Reset</button>
      </div>
      <div id="statusPill" class="statusBox status_bad">ERRORS DETECTED</div>
      <div class="small muted">Organizer: <strong>wrathofmath85@gmail.com</strong></div>
    </div>
  </footer>

<!-- EmailJS SDK (loaded only if DEMO_MODE === false) --> <script id="emailjs-sdk" type="text/plain"></script>

<!-- ========= SCRIPT ========= -->
<script>
/* =================== CONFIG (EDIT THESE) =================== */

// Google Sheets "Publish to web" CSV URLs 
const CSV_URL_PARTICIPANTS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTfQ7a2weK5Got7LTe3yVxqhcPR6pa-nPg73PdOMk8rrHwqlr3UeTcPprlgVbFjhFIVpifmMKnb_Tss/pub?gid=0&single=true&output=csv"; // Name, Email
const CSV_URL_NFL          = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSu8cw2ymTbcJGMmBkbcJTNzvxVsl4wh3XH7pbQJ3_pbSz42LFo0HKQHVLcJtHiOqtEDt37-hSegjDK/pub?gid=2109553148&single=true&output=csv";          // Away Team, Home Team, Date, Time, TV, Location, Spread, Required
const CSV_URL_NCAA         = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSu8cw2ymTbcJGMmBkbcJTNzvxVsl4wh3XH7pbQJ3_pbSz42LFo0HKQHVLcJtHiOqtEDt37-hSegjDK/pub?gid=0&single=true&output=csv";


// Current week label used in email subject line and summary 
const CURRENT_WEEK = 1;

// Global picks cut-off. After this moment, no one can submit.
// Provide an Eastern time string (same style as your sheet), we'll convert to UTC internally.
const PICKS_DEADLINE_ET = "Sept 6, 2025 12:00 PM"; // example; change as needed

// EmailJS
const DEMO_MODE          = false;                  // true: no real email, still shows "Submitted"
const EMAILJS_SERVICE_ID  = "service_txqdfck"; 
const EMAILJS_TEMPLATE_ID = "template_o8du7pt"; 
const EMAILJS_PUBLIC_KEY  = "w4UC6ofDTC0VdRI44";

/* ================ UTILITIES ================ */

const $ = s => document.querySelector(s); const $$= s => [...document.querySelectorAll(s)];

function escapeHtml(s){ return String(s??"").replace(/[&<>"]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m])); }

function bust(url){
  const sep = url.includes("?") ? "&" : "?";
  return url + sep + "_=" + Date.now();
}

// Fetch text with small cache-bust
async function fetchText(url){
  const r = await fetch(bust(url), {cache:"no-store"});
  if(!r.ok) throw new Error("Fetch failed for " + url);
  return r.text();
}

// Parse minimal CSV (first row header)
function parseCSV(text){
  const rows = text.trim().split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,"")));
  const [hdr, ...rest] = rows;
  return rest.map(r => Object.fromEntries(hdr.map((h,i)=>[h.trim(), r[i]??""]))); }

// Build a Date from Eastern date+time (sheet) and return a UTC Date object, // plus a user-facing local time string.
function makeLocalTimeFromET(dateStr, timeStr){
  if(!dateStr) return { utc:null, localText:"—", iso:"" };

  // Combine (e.g., "Sept 6, 2025 12:00 PM")
  const etString = (dateStr + " " + (timeStr||"")).trim();

  // Try fixed "America/New_York" interpretation
  let et;
  try{
    // Create a Date by manually parsing since Date.parse is locale sensitive.
    // We accept "Mon Sep 6, 2025 12:00 PM" style or "Sept 6, 2025 12:00 PM".
    et = new Date(etString + " GMT-0400"); // coarse nudge for EDT; if it’s EST time of year, offset differs automatically below.
    if(Number.isNaN(et.getTime())){
      // last-resort
      et = new Date(Date.parse(etString));
    }
  }catch(e){ et = null; }

  if(!et || Number.isNaN(et.getTime())){
    return { utc:null, localText:"—", iso:"" };
  }

  const utc = new Date(et.getTime()); // essentially the same absolute instant
  const localText = new Intl.DateTimeFormat(undefined, {
    weekday:"short", hour:"numeric", minute:"2-digit"
  }).format(utc);

  return { utc, localText, iso: utc.toISOString() }; }

// Format favorite like "Vikings -1.5" or "—"
function formatFavorite(away, home, spread){
  const s = String(spread||"").trim();
  if(!s) return "—";
  // spread is like "Vikings -1.5", or "SMU -3.0"
  return s;
}

/* ====== CSV → normalized game data ====== */ function normalizeGames(csvRows){
  // Expect columns: Away Team, Home Team, Date, Time, TV, Location, Spread, Required
  const out = [];
  for(const r of csvRows){
    const away = String(r["Away Team"]||r["Away"]||"").trim();
    const home = String(r["Home Team"]||r["Home"]||"").trim();
    const date = String(r["Date"]||"").trim();
    const time = String(r["Time"]||"").trim();
    const tv   = String(r["TV"]||"").trim();
    const loc  = String(r["Location"]||"").trim();
    const spr  = String(r["Spread"]||"").trim();
    const req  = /^y/i.test(String(r["Required"]||""));
    if(!away || !home) continue;

    const t = makeLocalTimeFromET(date, time);
    out.push({
      away, home,
      tv, loc,
      fav: formatFavorite(away, home, spr),
      deadline: t.utc,       // UTC Date (can be null)
      timeText: t.localText, // local reader-friendly time
      iso: t.iso,
      required: req
    });
  }
  return out;
}

/* ========== PAGE STATE ========== */

const state = {
  participants: [], // {name,email}
  nfl: [],          // normalized game objects
  ncaa: [],
  // answers keyed by qid ("A1","B7", etc)
  picks: new Map(), // qid -> "away" | "home"
  doubleQid: ""
};

function qidFor(prefix, index){ return `${prefix}${index+1}`; }

/* ======== BUILD ROW ======== */
function buildRow(prefix, index, game){
  const qid = qidFor(prefix, index);
  const expired = !!(game.deadline && (new Date() > game.deadline));

  const wrap = document.createElement("div");
  wrap.className = "row";
  wrap.dataset.qid = qid;

  const label = document.createElement("div");
  label.className = "label";
  label.textContent = `${game.away} @ ${game.home}`;
  wrap.appendChild(label);

  const details = document.createElement("div");
  details.className = "details";
  details.innerHTML = `
    <div><strong>Favorite:</strong> ${escapeHtml(game.fav)}</div>
    <div><strong>Day:</strong> ${game.timeText.split(",")[0] || "—"}</div>
    <div><strong>Time:</strong> ${escapeHtml(game.timeText || "—")}</div>
    <div><strong>Channel:</strong> ${escapeHtml(game.tv || "—")}</div>
    <div><strong>Location:</strong> ${escapeHtml(game.loc || "—")}</div>
  `;
  wrap.appendChild(details);

  const badgeRow = document.createElement("div");
  badgeRow.className = "badgeRow requiredHolder";
  if(game.required){
    const reqChip = document.createElement("span");
    reqChip.className = "chip mandatory";
    reqChip.textContent = "Required";
    badgeRow.appendChild(reqChip);
  }
  if(expired){
    const expChip = document.createElement("span");
    expChip.className = "chip expired";
    expChip.textContent = "Expired";
    badgeRow.appendChild(expChip);
  }
  if(badgeRow.children.length) wrap.appendChild(badgeRow);

  const answers = document.createElement("div");
  answers.className = "answers";
  const disabledAttr = expired ? "disabled" : "";
  answers.innerHTML = `
    <label><input type="radio" name="${qid}" value="away" ${disabledAttr}> ${escapeHtml(game.away)}</label>
    <label><input type="radio" name="${qid}" value="home" ${disabledAttr}> ${escapeHtml(game.home)}</label>
  `;
  wrap.appendChild(answers);

  const clearBtn = document.createElement("button");
  clearBtn.type = "button";
  clearBtn.className = "btn ghost clear";
  clearBtn.textContent = "Clear";
  clearBtn.disabled = expired;
  clearBtn.dataset.clear = qid;
  wrap.appendChild(clearBtn);

  return wrap;
}

/* ======== RENDER SECTIONS ======== */
function renderSection(container, games, prefix){
  container.innerHTML = "";
  const list = normalizeGames(games);
  if(!list.length){
    container.innerHTML = `<p class="small muted">No games found (check sheet headers and “Spread” column).</p>`;
    return;
  }
  list.forEach((g,i)=> container.appendChild(buildRow(prefix,i,g)));
}

/* ======== COUNTS, SUMMARY, VALIDATION ======== */ function refreshCountsAndSummary(){
  // Count per section
  const nflAnswered  = $$('#nflList input[type="radio"]:checked').length;
  const ncaaAnswered = $$('#ncaaList input[type="radio"]:checked').length;
  $('#nflCount').textContent  = `Answered: ${nflAnswered}`;
  $('#ncaaCount').textContent = `Answered: ${ncaaAnswered}`;

  // Build picks map and double options
  state.picks.clear();
  $$('.row').forEach(row=>{
    const qid = row.dataset.qid;
    const sel = row.querySelector('input[type="radio"]:checked');
    if(sel) state.picks.set(qid, sel.value); // away|home
  });

  const doubleSel = $('#doubleSel');
  const keep = new Set(state.picks.keys());
  const current = doubleSel.value;
  doubleSel.innerHTML = `<option value="">— No double —</option>`;
  [...keep].sort().forEach(q=>{
    const opt = document.createElement('option');
    opt.value = q; opt.textContent = q;
    doubleSel.appendChild(opt);
  });
  if(keep.has(current)) doubleSel.value = current; else doubleSel.value = "";

  // Summary
  const lines = [];
  lines.push(`Name: ${$('#nameSel').value || "—"}`);
  lines.push(`Email: ${$('#emailBox').value || "—"}`);
  lines.push(`Week: ${CURRENT_WEEK}`);
  lines.push(`Timestamp: ${new Date().toISOString()}`);
  lines.push("");
  lines.push("Selections:");
  // iterate rows in visual order
  $$('.row').forEach(row=>{
    const qid = row.dataset.qid;
    const sel = row.querySelector('input[type="radio"]:checked');
    if(sel){
      const team = sel.parentElement.textContent.trim();
      const isDouble = (qid === $('#doubleSel').value);
      lines.push(`${qid}:${team}${isDouble ? " [DOUBLE]" : ""}`);
    }
  });
  $('#summary').textContent = lines.join("\n");

  // Validate and status pill
  const errors = validateAll();
  const pill = $('#statusPill');
  if(errors.length){
    pill.className = "statusBox status_bad";
    pill.textContent = "ERRORS DETECTED";
  }else{
    pill.className = "statusBox status_good";
    pill.textContent = "BEAR DOWN!";
  }
}

function validateAll(){
  const errs = [];
  const name = $('#nameSel').value.trim();
  const email= $('#emailBox').value.trim();
  if(!name) errs.push("Pick your name.");
  if(!/^\S+@\S+\.\S+$/.test(email)) errs.push("Enter a valid email.");

  // Required rows must be answered (and not expired)
  $$('.row').forEach(row=>{
    const isReq = !!row.querySelector('.chip.mandatory');
    const isExpired = !!row.querySelector('.chip.expired');
    if(isReq && !isExpired){
      const picked = row.querySelector('input[type="radio"]:checked');
      if(!picked) errs.push(`Required game ${row.dataset.qid} not answered.`);
    }
  });

  const nflPicked  = $$('#nflList input[type="radio"]:checked').length;
  const ncaaPicked = $$('#ncaaList input[type="radio"]:checked').length;
  const total = nflPicked + ncaaPicked;
  if(nflPicked < 3) errs.push("Answer at least 3 NFL games.");
  if(ncaaPicked < 3) errs.push("Answer at least 3 College games.");
  if(total < 7 || total > 12) errs.push("Answer between 7 and 12 total games.");

  // If double chosen, it must be among selected
  const dbl = $('#doubleSel').value;
  if(dbl && !state.picks.has(dbl)) errs.push("Double must be one of your selections.");

  // Global picks deadline (hard stop)
  const cut = parseETToDate(PICKS_DEADLINE_ET);
  if(cut && new Date() > cut) errs.push("Picks window is closed.");

  // Render list
  const ul = $('#errorList');
  ul.innerHTML = "";
  errs.forEach(e=>{
    const li = document.createElement('li');
    li.textContent = e;
    ul.appendChild(li);
  });
  return errs;
}

/* Parse a single "ET" datetime string → Date */ function parseETToDate(etString){
  if(!etString) return null;
  const d = new Date(etString + " GMT-0400"); // coarse hint for EDT
  if(Number.isNaN(d.getTime())) return null;
  return d;
}

/* ======== EMAIL ======== */

function ensureEmailJSLib(){
  if(DEMO_MODE) return Promise.resolve("demo");
  return new Promise((resolve, reject)=>{
    const slot = document.getElementById('emailjs-sdk');
    // load once
    if(slot.type === "text/javascript"){ return resolve("ready"); }
    slot.type = "text/javascript";
    slot.src = "https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js";
    slot.onload = ()=>{
      try{
        emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });
        resolve("ready");
      }catch(e){ reject(e); }
    };
    slot.onerror = ()=> reject(new Error("EmailJS SDK failed to load"));
    document.body.appendChild(slot);
  });
}

function buildSelectionsText(){
  // same content the summary shows
  return $('#summary').textContent;
}

async function sendEmail(){
  if(DEMO_MODE){
    alert("Submitted (DEMO MODE). No email sent.");
    return;
  }
  await ensureEmailJSLib();

  const participant_name = $('#nameSel').value || "";
  const selections_text  = buildSelectionsText();

  const params = { participant_name, selections_text };

  try{
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params);
    alert("Submitted! A copy will be CC’d to you.");
  }catch(e){
    console.error(e);
    alert("Could not send via EmailJS. Check your service / template / public key.");
  }
}

/* ======== WIRING ======== */
function wireRowEvents(){
  // radios
  $$('.row input[type="radio"]').forEach(r=>{
    r.addEventListener('change', ()=>{
      // keep selections in both sections independent (fixes “selecting Vikings unselects Illinois”)
      refreshCountsAndSummary();
    });
  });
  // clear buttons
  $$('.row .clear').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const qid = btn.dataset.clear;
      $$(`input[name="${qid}"]`).forEach(r=>{ r.checked=false; });
      refreshCountsAndSummary();
    });
  });
}

function wireTopControls(){
  $('#doubleSel').addEventListener('change', refreshCountsAndSummary);
  $('#nameSel').addEventListener('change', ()=>{
    const found = state.participants.find(p=>p.Name=== $('#nameSel').value);
    if(found) $('#emailBox').value = found.Email || "";
    refreshCountsAndSummary();
  });
  $('#emailBox').addEventListener('input', refreshCountsAndSummary);

  $('#resetBtn').addEventListener('click', ()=>{
    $$('.row input[type="radio"]').forEach(r=> r.checked=false);
    $('#doubleSel').value="";
    refreshCountsAndSummary();
  });

  $('#submitBtn').addEventListener('click', async ()=>{
    const errs = validateAll();
    if(errs.length){
      alert("Please fix the errors first.");
      return;
    }
    // gentle confirm if no double
    if(!$('#doubleSel').value){
      const ok = confirm("Submit with NO double?");
      if(!ok) return;
    }
    await sendEmail();
  });
}

/* ======== LOAD EVERYTHING ======== */
async function loadAll(){
  try{
    // Participants
    const partCsv = parseCSV(await fetchText(CSV_URL_PARTICIPANTS));
    state.participants = partCsv.map(r => ({Name:r["Name"]||"", Email:r["Email"]||""})).filter(p=>p.Name);
    // fill names
    const sel = $('#nameSel');
    state.participants.forEach(p=>{
      const o = document.createElement('option');
      o.value = p.Name; o.textContent = p.Name;
      sel.appendChild(o);
    });

    // Lines
    state.nfl  = parseCSV(await fetchText(CSV_URL_NFL));
    state.ncaa = parseCSV(await fetchText(CSV_URL_NCAA));

    renderSection($('#nflList'),  state.nfl,  "A");
    renderSection($('#ncaaList'), state.ncaa, "B");

    wireRowEvents();
    wireTopControls();
    refreshCountsAndSummary();
  }catch(e){
    console.error(e);
    alert("Could not load one or more CSV files. Check the URLs and that they are published as CSV.");
  }
}

document.addEventListener('DOMContentLoaded', loadAll); </script> </body> </html>

