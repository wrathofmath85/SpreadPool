<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spread Pool — Picks</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  /* (your CSS unchanged) */
</style>
</head>
<body>
<div class="wrap">
  <h1 id="pageTitle">Spread Pool — Picks</h1>

  <div id="err"></div>
  <div id="gamesPanel" class="games"></div>
  <div class="note">Set the official result per game. If the <strong>Winner</strong> column is filled in the Lines sheet, the game is locked for everyone. Totals & standings update instantly.</div>
  <div id="list"></div>
  <div class="standings" id="standingsWrap" hidden>
    <h2>Standings</h2>
    <div class="toolbar">
      <button id="sort-alpha">Alphabetical</button>
      <button id="sort-percent">By Win %</button>
      <button id="sort-wins">Most Wins</button>
    </div>
    <div id="standings"></div>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const WEEK = 1;  // <<<<<<<<<<<<<<<<<<< week selector

const CSV_URL_LINES_NFL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRB9bXyC3PBzUhxALXDBAfdsKUAarhukkrtwHEeR64Sj7tB3kb5FZO-PvFOVX57srWOoVNPFO7yjpUf/pub?gid=2109553148&single=true&output=csv";
const CSV_URL_LINES_NCAA= "https://docs.google.com/spreadsheets/d/e/2PACX-1vRB9bXyC3PBzUhxALXDBAfdsKUAarhukkrtwHEeR64Sj7tB3kb5FZO-PvFOVX57srWOoVNPFO7yjpUf/pub?gid=0&single=true&output=csv";
const CSV_URL_SUBS      = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRys9xayYsuEqgGB09v1nOrwdD0U5c1Hb1ksLqQxTSBzLi3AKGeg9yPt1-eY1fry_0H-KcZLCQ1h8H6/pub?gid=0&single=true&output=csv";
const CSV_URL_PARTICIPANTS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRj5ieGlGWurIlGuongV3vJhWWAwCYsEFVhEEtjwOG7RiFwTRZkM_JXtjb8QtwsdzhaXPMDRPyU7qZC/pub?gid=0&single=true&output=csv";

const DOUBLE_COUNTS_AS = 2;
/* ============================================ */

document.getElementById("pageTitle").textContent = `Spread Pool — Week ${WEEK} Picks`;

const by = f => (a,b)=> f(a)<f(b)?-1:f(a)>f(b)?1:0;
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}
function qidOrder(q){ if(!q) return 9999; const s=q[0], n=parseInt(q.slice(1),10); return (s==='A'?0:1)*1000 + (isFinite(n)?n:999); }

function showErr(msg){ /* unchanged */ }

function fetchCSV(url){ /* unchanged */ }

function normTeam(s){ /* unchanged */ }
function fmtPct(n){ return (isNaN(n) ? "" : (n*100).toFixed(1) + "%"); }
function toDate(val){ /* unchanged */ }
function escapeRegex(s){ /* unchanged */ }

/* ============== STATE ============== */
let qidToLine   = new Map();
let qidToAway   = new Map();
let qidToHome   = new Map();
let qidToWinner = new Map();
let qidToDate   = new Map();
let results     = new Map();
let people      = [];
let participantNames = [];
let defaultTemplate = null;
let standingsSort = 'alpha';

/* ============== LOAD & PREP ============== */
function normalizeLines(rows){ /* unchanged */ }

function normalizeSubs(rows){
  // filter to this WEEK
  rows = rows.filter(r => String(r["Week"]||r["week"]||"").trim() === String(WEEK));

  const latest = new Map();
  rows.forEach(r=>{
    const name = String(r["Name"]||r["name"]||"").trim();
    if(!name) return;
    const ts = String(r["Timestamp"]||r["timestamp"]||"").trim();
    const prev = latest.get(name);
    if(!prev || ts > prev) latest.set(name, ts);
  });

  const byName = new Map();
  rows.forEach(r=>{
    const name   = String(r["Name"]||r["name"]||"").trim();
    const ts     = String(r["Timestamp"]||r["timestamp"]||"").trim();
    const qid    = String(r["QID"]||r["qid"]||"").trim();
    const choice = String(r["Choice"]||r["choice"]||"").trim();
    const isDouble = String(r["IsDouble"]).toUpperCase()==="TRUE";
    if(!name || !qid) return;
    if(latest.get(name) && ts !== latest.get(name)) return;

    const p = byName.get(name) || { name, picks: [] };
    p.picks.push({ qid, choice, isDouble });
    byName.set(name, p);
  });

  const arr = Array.from(byName.values());
  arr.forEach(p => p.picks.sort((a,b)=> qidOrder(a.qid)-qidOrder(b.qid)));
  arr.sort((a,b)=> a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));
  return arr;
}

function normalizeParticipants(rows){ /* unchanged */ }
function outcomeFromWinner(qid){ /* unchanged */ }
function detectFavorite(qid){ /* unchanged */ }
function computeDefaultPicksSet(){ /* unchanged */ }

async function loadAll(){
  try{
    showErr('');
    const [linesNFL, linesNCAA, subs, parts] = await Promise.all([
      fetchCSV(CSV_URL_LINES_NFL),
      fetchCSV(CSV_URL_LINES_NCAA),
      fetchCSV(CSV_URL_SUBS),
      fetchCSV(CSV_URL_PARTICIPANTS)
    ]);

    qidToLine.clear(); qidToAway.clear(); qidToHome.clear(); qidToWinner.clear(); qidToDate.clear(); results.clear();
    normalizeLines(linesNFL);
    normalizeLines(linesNCAA);

    Array.from(qidToLine.keys()).forEach(qid=>{
      const oc = outcomeFromWinner(qid);
      if(oc) results.set(qid, oc);
    });

    people = normalizeSubs(subs);
    participantNames = normalizeParticipants(parts);

    defaultTemplate = { name:"Default Picks", picks: computeDefaultPicksSet(), isDefaults:true };

    const have = new Set(people.map(p=>p.name.toLowerCase()));
    participantNames.forEach(nm=>{
      if(!have.has(nm.toLowerCase())){
        people.push({ name:nm, picks:[...defaultTemplate.picks], isDefaults:true });
      }
    });

    people.sort((a,b)=> a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));

    renderGames();
    renderPeople();
    hookSortButtons();
  }catch(e){
    console.error(e);
    showErr('Failed to load CSV: ' + (e && e.message ? e.message : e));
  }
}

/* === rest of your renderGames, scorePick, renderPeople, renderStandings, hookSortButtons unchanged === */

loadAll();
</script>
</body>
</html>
